> [JWT认证中如何防止他人冒充token？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/364616467)
> [接口调度者——API 网关 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/215901217)
> [开放API接口签名验证，让你的接口从此不再裸奔 - 简书 (jianshu.com)](https://www.jianshu.com/p/ad410836587a)
> [微服务网关选型：5种主流 API 网关，哪个最香！ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/500587132)
### 防止篡改

JWT 本质上就是一组字串，通过（`.`）切分成三个为 **Base64 编码**的部分：

- **Header** : 描述 JWT 的元数据，定义了生成签名的算法以及 `Token` 的类型。
- **Payload** : 用来存放实际需要传递的数据
- **Signature（签名）**：服务器通过 Payload、Header 和一个密钥(Secret)使用 Header 里面指定的签名算法（默认是 HMAC SHA256）生成。

签名哈希部分是对上面两部分数据签名，通过指定的算法生成哈希，以确保数据不会被篡改。

首先，需要指定一个密码（secret）。该密码仅仅为保存在服务器中，并且不能向用户公开。

假如有人对头部和负载的内容解码之后进行修改，再进行编码，最后加上之前的签名组合形成新的JWT的话，这样服务器端可以判断出新的头部和负载形成的签名和JWT附带上的签名是不一样的，这样服务器端就可以知道数据被篡改了。

## 重放问题
这个问题很简单，比对于某个接口（支付100W给某人），必须是只能一次请求，一次有效。
### timestamp+nonce方案

nonce指**唯一的随机字符串**，用来标识每个被签名的请求。通过为每个请求提供一个唯一的标识符，服务器能够防止请求被多次使用（记录所有用过的nonce以阻止它们被二次使用）。

然而，对服务器来说永久存储所有接收到的nonce的代价是非常大的。可以使用**timestamp来优化nonce的存储**。

假设允许客户端和服务端最多能存在15分钟的时间差，同时追踪记录在服务端的nonce集合。当有新的请求进入时，首先检查携带的timestamp是否在15分钟内，如超出时间范围，则拒绝，然后查询携带的nonce，如存在已有集合，则拒绝。否则，记录该nonce，并删除集合内时间戳大于15分钟的nonce（可以使用redis的expire，新增nonce的同时设置它的超时失效时间为15分钟）。
## 防止 jwt 泄露后被滥用

因为 http 是无状态的协议，普通的 jwt 泄露后即使被滥用，也可以通过一定的手段保护，比如限制虽大访问次数等等，就不会产生很大损失。

但是也因为 http 是无状态的协议，所以如果我们想要实现一个无感知刷新的功能（以旧Token换新Token），就相当于为Token续命，那盗用者也可以无限续用了

这个问题需要解决的是，如果用户的 jwt 被盗用，岂不是任何人都可以伪造为 jwt 所有者用户使用他的权限？

关于这个问题，首先需要提出一些不能完全解决的办法，因为这些办法也是很具有实际意义的

- **存储Token时使用加密**：仅加大了获取的难度
- **不要在Token中包含敏感信息**：可以保证信息安全，但还是没有保证权限
- **使用尽量短期的访问Token**：能力有限
- **撤销Token功能（用户登出时）**：无法彻底避免
- **使用HTTPS**：仅加大了获取的难度

### Token+AppKey签名验证
为客户端分配**AppKey**（密钥，用于接口加密，不参与传输），将AppKey和所有请求参数组合成源串

根据**签名算法**生成签名值，发送请求时将签名值一起发送给服务器验证。

这样，即使Token被劫持，对方不知道AppKey和签名算法，就无法伪造请求和篡改参数。再结合上述的**重发攻击**解决方案，即使请求参数被劫持也无法伪造二次重复请求。

### 使用api网关
计算机的世界有一句至理名言：任何问题都可以通过增加中间层的方式解决

- 配置 API 网关以执行有效的请求验证和授权。
- 实施访问控制策略，限制对受保护资源的访问。
- 设置访问速率限制和 IP 黑名单等安全措施。
- ……功能还有很多，远不止于实现则这个功能。

概述起来就是**二次验证、重点资源保护和防止恶意攻击**
### 双 Token 方案
双 Token 方案通常指的是使用两种不同的令牌来进行身份验证和访问控制。一种是访问令牌（Access Token），用于实际访问受保护资源；另一种是刷新令牌（Refresh Token），用于获取新的访问令牌。这种方案可以一定程度上减轻令牌被泄露所带来的安全风险。

以下是双 Token 方案如何解决令牌被泄露的问题：

1. **有限的有效期**：访问令牌通常具有较短的有效期，而刷新令牌具有更长的有效期。因此，即使访问令牌被泄露，攻击者也只能在较短的时间内进行滥用。一旦访问令牌过期，攻击者将无法继续使用。
    
2. **轻量级访问令牌**：访问令牌通常只包含基本的用户信息和访问权限信息，而不包含敏感信息。即使访问令牌被泄露，攻击者也无法获取到太多敏感信息。
    
3. **刷新令牌的安全保护**：刷新令牌通常存储在安全的地方，例如客户端的本地存储或者安全的 HTTP-only Cookie 中，以防止被恶意截获。此外，刷新令牌的获取通常需要进行身份验证，确保只有合法用户才能获取到新的访问令牌。
    
4. **定期刷新令牌**：在使用刷新令牌获取新的访问令牌时，可以同时生成一个新的刷新令牌。这样即使原来的刷新令牌被泄露，攻击者也无法长时间持续地滥用。
    
5. **可撤销的刷新令牌**：如果发现刷新令牌被泄露或者被滥用，可以在服务器端撤销该刷新令牌，从而阻止攻击者进一步使用它。
    

综合利用访问令牌和刷新令牌，双 Token 方案可以有效地降低令牌被泄露所带来的安全风险，并提高系统的安全性。但是，也需要注意对刷新令牌进行安全保护，以防止被恶意利用。