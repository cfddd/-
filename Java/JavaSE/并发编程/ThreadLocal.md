
## ä¸€ã€ThreadLocal æ˜¯ä»€ä¹ˆ

ThreadLocal æ˜¯ Java æä¾›çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚

å®ƒè§£å†³çš„é—®é¢˜æ˜¯ï¼š**åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¦‚ä½•é¿å…å…±äº«å˜é‡å¯¼è‡´çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚**

æ¯ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ª ThreadLocal å®ä¾‹è°ƒç”¨ `get()` å’Œ `set()` æ–¹æ³•æ—¶ï¼Œè®¿é—®çš„æ˜¯çº¿ç¨‹è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œäº’ä¸å¹²æ‰°ã€‚

---

## äºŒã€ThreadLocal çš„å®ç°ç»“æ„

æ¯ä¸ªçº¿ç¨‹ï¼ˆ`Thread` å®ä¾‹ï¼‰å†…éƒ¨æœ‰ä¸€ä¸ª `ThreadLocalMap` å­—æ®µï¼Œç”¨äºå­˜å‚¨è¯¥çº¿ç¨‹çš„æ‰€æœ‰ ThreadLocal å˜é‡å‰¯æœ¬ã€‚

- `Thread` ç±»ä¸­æœ‰ä¸€ä¸ªå­—æ®µï¼š
    
    ```java
    ThreadLocal.ThreadLocalMap threadLocals;
    ```
    
- è¯¥ map çš„ key æ˜¯ `ThreadLocal` å®ä¾‹ï¼ˆå¼±å¼•ç”¨ï¼‰ï¼Œvalue æ˜¯çº¿ç¨‹æœ¬åœ°å˜é‡çš„å€¼ã€‚
    

---

## ä¸‰ã€ThreadLocal ä¸ ThreadLocalMap çš„å…³ç³»

| é¡¹ç›®   | ThreadLocal                | ThreadLocalMap                      |
| ---- | -------------------------- | ----------------------------------- |
| ç±»å‹   | å…¬å…±æ¥å£ç±»                      | ThreadLocal çš„å†…éƒ¨é™æ€ç±»                  |
| ä½œç”¨   | å¯¹ç”¨æˆ·æš´éœ²çš„æ“ä½œæ¥å£ï¼ˆget/set/removeï¼‰ | å®é™…å­˜å‚¨çº¿ç¨‹æœ¬åœ°å˜é‡å‰¯æœ¬çš„å®¹å™¨                     |
| å­˜å‚¨ä½ç½® | é€šå¸¸ä½œä¸ºé™æ€å­—æ®µå­˜åœ¨                 | æ¯ä¸ª Thread å®ä¾‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª threadLocals å­—æ®µ  |
| å­˜å‚¨ç»“æ„ | æ— å…·ä½“æ•°æ®ç»“æ„ï¼Œä»…ä½œä¸ºè®¿é—® key          | å“ˆå¸Œè¡¨ï¼Œkey æ˜¯å¼±å¼•ç”¨çš„ ThreadLocalï¼Œvalue æ˜¯æ•°æ® |

å½“è°ƒç”¨ `ThreadLocal.set()` æ—¶ï¼ŒThreadLocal ä¼šè·å–å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap`ï¼Œå¹¶ä»¥è‡ªèº«ä¸º key å­˜å‚¨å˜é‡å‰¯æœ¬ã€‚

---

## å››ã€ThreadLocal çš„ä¸»è¦æ–¹æ³•

|æ–¹æ³•|è¯´æ˜|
|---|---|
|`set(T value)`|è®¾ç½®å½“å‰çº¿ç¨‹çš„å˜é‡å‰¯æœ¬|
|`get()`|è·å–å½“å‰çº¿ç¨‹çš„å˜é‡å‰¯æœ¬|
|`remove()`|åˆ é™¤å½“å‰çº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼|
|`withInitial(Supplier)`|è®¾ç½®åˆå§‹å€¼ï¼ˆJava 8+ï¼‰|

---

## äº”ã€åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„å¤šä¸ª ThreadLocal æ˜¯å¦ç›¸äº’å¹²æ‰°ï¼Ÿ

ä¸ä¼šã€‚

- æ¯ä¸ªçº¿ç¨‹çš„ `ThreadLocalMap` å¯ä»¥å­˜å‚¨å¤šä¸ªä¸åŒçš„ ThreadLocal å®ä¾‹
    
- è¿™äº›å®ä¾‹ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œå½¼æ­¤çš„ key-value æ˜¯ç‹¬ç«‹çš„
    
- åŒä¸€çº¿ç¨‹å†…å¯ä»¥ä½¿ç”¨å¤šä¸ª ThreadLocalï¼Œåˆ†åˆ«ç®¡ç†ä¸åŒç±»å‹çš„æ•°æ®
    

---

## å…­ã€ä¸ºä»€ä¹ˆä¸ä¼ é€’ ThreadLocal å¼•ç”¨ï¼Ÿ

ThreadLocal çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†é¿å…åœ¨æ·±å±‚è°ƒç”¨é“¾ä¸­æ˜¾å¼åœ°ä¼ é€’ä¸Šä¸‹æ–‡å‚æ•°ã€‚

é€šè¿‡å°† ThreadLocal å®ä¾‹å£°æ˜ä¸ºé™æ€å˜é‡ï¼ˆä¾‹å¦‚é™æ€å·¥å…·ç±»ä¸­çš„é™æ€å­—æ®µï¼‰ï¼Œä»»ä½•æ–¹æ³•ä¸­åªè¦è¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼Œéƒ½å¯ä»¥é€šè¿‡ ThreadLocal çš„ `get()` è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å€¼ã€‚

**è¿™æ ·å¯ä»¥é¿å…æ˜¾å¼åœ°åœ¨æ¯å±‚æ–¹æ³•ä¼ é€’è¯¥å€¼ï¼Œç®€åŒ–ä»£ç ç»“æ„ã€‚**

---

## ä¸ƒã€ä¸ºä»€ä¹ˆ ThreadLocalMap çš„ key è¦ä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ

1. **é˜²æ­¢å†…å­˜æ³„æ¼**
    
    - å¦‚æœ key æ˜¯å¼ºå¼•ç”¨ï¼Œå½“ ThreadLocal å®ä¾‹åœ¨å¤–éƒ¨å·²ç»ä¸å†ä½¿ç”¨ï¼Œä½† `ThreadLocalMap` ä¸­è¿˜æŒæœ‰å¼•ç”¨ï¼Œå®ƒå°±æ°¸è¿œä¸ä¼šè¢« GCã€‚
        
    - ç‰¹åˆ«æ˜¯åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œè¿™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚
        
2. **å¼±å¼•ç”¨å…è®¸ GC è‡ªåŠ¨å›æ”¶ä¸å†ä½¿ç”¨çš„ ThreadLocal å¯¹è±¡**
    
    - ä¸€æ—¦å¤–éƒ¨ä¸å†å¼•ç”¨ ThreadLocal å®ä¾‹ï¼ŒGC å¯ä»¥å›æ”¶å®ƒ
        
    - `ThreadLocalMap` çš„ key ä¼šå˜æˆ nullï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å†…éƒ¨æœºåˆ¶æ¸…ç†å¯¹åº”çš„ value
        
3. **value æ˜¯å¼ºå¼•ç”¨ï¼Œä»ç„¶å¯èƒ½é€ æˆæ³„æ¼**
    
    - å³ä½¿ key è¢« GCï¼Œvalue ä»ç„¶å­˜åœ¨äº map ä¸­ï¼Œä¸èƒ½è‡ªåŠ¨å›æ”¶
        
    - æ‰€ä»¥ï¼Œå¼€å‘è€…ä½¿ç”¨ ThreadLocal æ—¶ï¼Œåº”è¯¥åœ¨ä½¿ç”¨å®Œæ¯•åè°ƒç”¨ `remove()` ä¸»åŠ¨æ¸…ç†
        
>**ThreadLocal è™½ç„¶æ˜¯å¼±å¼•ç”¨è¢«å­˜è¿›äº† ThreadLocalMap çš„ keyï¼Œä½†**åªè¦ä½ åœ¨ä»£ç é‡Œæœ‰å¯¹è¿™ä¸ª `ThreadLocal` å®ä¾‹çš„**å¼ºå¼•ç”¨**ï¼ˆæ¯”å¦‚å­˜åœ¨å˜é‡é‡Œã€é™æ€å­—æ®µé‡Œï¼‰ï¼Œé‚£å®ƒ**ç»å¯¹ä¸ä¼šè¢« GC å›æ”¶**ã€‚
---

## å…«ã€ä¸ºä»€ä¹ˆä¸åœ¨çº¿ç¨‹ç»“æŸåå†æ¸…ç†å°±å¥½ï¼Ÿ

å› ä¸ºï¼š

- å¾ˆå¤šçº¿ç¨‹ä¸ä¼šå¾ˆå¿«ç»“æŸï¼Œæ¯”å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¼šè¢«å¤ç”¨
    
- å¦‚æœåªä¾èµ–çº¿ç¨‹ç»“æŸæ¥æ¸…ç† ThreadLocalï¼Œé‚£ä¹ˆè¿™ç±»çº¿ç¨‹ä¸­ç»‘å®šçš„å˜é‡ä¼šé•¿æœŸæ®‹ç•™åœ¨å†…å­˜ä¸­ï¼Œå¯¼è‡´æ³„æ¼
    
- å¼€å‘è€…ä¹Ÿå®¹æ˜“å¿˜è®°æ‰‹åŠ¨æ¸…ç†
    

å› æ­¤ï¼š

- ThreadLocal è®¾è®¡ä¸ºå¼±å¼•ç”¨ key
    
- value è™½ç„¶æ˜¯å¼ºå¼•ç”¨ï¼Œä½†å½“ key è¢« GCï¼Œæ¡†æ¶èƒ½æ£€æµ‹å‡ºâ€œkey ä¸º nullâ€çš„ entryï¼Œæœ‰æœºä¼šæ¸…é™¤å®ƒ
    

**æ¨èåšæ³•ï¼šä½¿ç”¨å®Œæ¯•åç«‹å³è°ƒç”¨ `remove()`ã€‚**

---

## ä¹ã€ThreadLocal çš„å…¸å‹ä½¿ç”¨åœºæ™¯

|åœºæ™¯|åŸå› |
|---|---|
|Web è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆå¦‚ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼‰|åŒä¸€ä¸ªè¯·æ±‚ä¸€èˆ¬ç»‘å®šåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šï¼Œä½¿ç”¨ ThreadLocal å­˜å‚¨ä¸Šä¸‹æ–‡|
|æ—¥å¿—è·Ÿè¸ªï¼ˆå¦‚ traceIdï¼‰|æ—¥å¿—ç³»ç»Ÿåœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­è®°å½•ç›¸åŒ traceIdï¼ŒThreadLocal å¯éšå¼ä¼ é€’|
|æ•°æ®åº“è¿æ¥ç®¡ç†ï¼ˆå¦‚äº‹åŠ¡ç®¡ç†ï¼‰|æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ªè¿æ¥å®ä¾‹ï¼Œé¿å…å…±äº«è¿æ¥|
|éçº¿ç¨‹å®‰å…¨å·¥å…·ç±»å°è£…ï¼ˆå¦‚ SimpleDateFormatï¼‰|é¿å…å¤šä¸ªçº¿ç¨‹å…±äº«å®ä¾‹å¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜|

---

## åã€ThreadLocal ä½¿ç”¨ç¤ºä¾‹

```java
public class UserContext {
    private static final ThreadLocal<User> userHolder = new ThreadLocal<>();

    public static void set(User user) {
        userHolder.set(user);
    }

    public static User get() {
        return userHolder.get();
    }

    public static void clear() {
        userHolder.remove();
    }
}
```

ä½¿ç”¨ï¼š

```java
try {
    UserContext.set(currentUser);
    // åç»­ä¸šåŠ¡ä¸­ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥é€šè¿‡ UserContext.get() è·å–å½“å‰ç”¨æˆ·
} finally {
    UserContext.clear(); // é˜²æ­¢å†…å­˜æ³„æ¼
}
```

---

## åä¸€ã€ThreadLocal ä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”

|æ–¹å¼|æ˜“ç”¨æ€§|å®‰å…¨æ€§|æ˜¯å¦çº¿ç¨‹éš”ç¦»|ç¼ºç‚¹|
|---|---|---|---|---|
|ThreadLocal|é«˜|é«˜|æ˜¯|ä½¿ç”¨åéœ€æ‰‹åŠ¨æ¸…ç†ï¼Œé¿å…æ³„æ¼|
|å‚æ•°ä¼ é€’|é«˜|é«˜|æ— ï¼ˆé æ‰‹åŠ¨ä¼ å‚ï¼‰|æ–¹æ³•ç­¾åå¤æ‚ï¼Œè°ƒç”¨é“¾è‡ƒè‚¿|
|Map<Thread, Object>|ä½|ä½|æ˜¯|å®¹æ˜“æ³„æ¼ã€çº¿ç¨‹ä¸å®‰å…¨ã€æ‰‹åŠ¨ç®¡ç†å¤æ‚|

---

## åäºŒã€æœ€ä½³å®è·µ

- ThreadLocal å®ä¾‹é€šå¸¸å®šä¹‰ä¸º `private static final` å­—æ®µ
    
- æ¯æ¬¡ä½¿ç”¨å‰ `set()`ï¼Œä½¿ç”¨åå¿…é¡» `remove()`
    
- é€‚åˆåœ¨çº¿ç¨‹å†…åšâ€œéšå¼ä¸Šä¸‹æ–‡ä¼ é€’â€ï¼Œé¿å…å¤§é‡æ˜¾å¼å‚æ•°ä¼ é€’
    

ç¤ºä¾‹ï¼š

```java
private static final ThreadLocal<Connection> connHolder = new ThreadLocal<>();

public static void openConnection() {
    Connection conn = DriverManager.getConnection(...);
    connHolder.set(conn);
}

public static Connection getConnection() {
    return connHolder.get();
}

public static void closeConnection() {
    conn.close();
    connHolder.remove();
}
```

---

## åä¸‰ã€æ€»ç»“

- ThreadLocal æ˜¯ä¸ºçº¿ç¨‹æä¾›ç§æœ‰å˜é‡çš„æœºåˆ¶ï¼Œå¸¸ç”¨äºçº¿ç¨‹å†…éƒ¨ä¸Šä¸‹æ–‡éš”ç¦»
    
- æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ ThreadLocalMapï¼Œkey æ˜¯ ThreadLocal å®ä¾‹çš„å¼±å¼•ç”¨ï¼Œvalue æ˜¯å…·ä½“æ•°æ®
    
- é¿å…æ˜¾å¼å‚æ•°ä¼ é€’ï¼Œé€‚åˆæ§åˆ¶è°ƒç”¨é“¾ä¸Šä¸‹æ–‡
    
- ä½¿ç”¨å®Œå¿…é¡»è°ƒç”¨ `remove()` é¿å…å†…å­˜æ³„æ¼ï¼Œå°¤å…¶åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸­
    
- åº”ç”¨å¹¿æ³›ï¼Œå°¤å…¶åœ¨ Web æ¡†æ¶ã€æ—¥å¿—ã€æ•°æ®åº“ç®¡ç†ä¸­
    
## åå››ã€æ‹“å±•å»¶ä¼¸
### èƒŒæ™¯é—®é¢˜
æˆ‘æœ‰ä¸ªè¶…ç»çš„ç‚¹å­ï¼Œåœ¨threadæ‰§è¡Œå½“å‰ä»»åŠ¡å®Œæ¯•åï¼Œç«‹åˆ»æ‰‹åŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹æ‰€æœ‰çš„ThreadLocalï¼Œä¸éœ€è¦å¼€å‘äººå‘˜åœ¨æ‰‹åŠ¨å»å†™ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å¾ˆå¥½~å¦‚æœæŠ€æœ¯ä¸Šæ²¡æ³•å®ç°ï¼Œä½†ä¸ºäº†å¼ºåˆ¶æ‰€æœ‰å¼€å‘äººå‘˜éƒ½éµå®ˆæœ€ä½³å®è·µï¼Œå¦‚æœæ²¡æœ‰removeå°±æŠ›å¼‚å¸¸ï¼Œæˆ–è€…è‡ªåŠ¨æ¸…é™¤
### é—®é¢˜æ‹†è§£
>- **è‡ªåŠ¨æ¸…ç† ThreadLocalï¼š**  ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åï¼Œè‡ªåŠ¨æ¸…ç†çº¿ç¨‹å†…æ‰€æœ‰ ThreadLocalï¼Œå¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `remove()`ã€‚
> - **æŠ€æœ¯å®ç°æ˜¯å¦å¯è¡Œï¼Ÿ**  Java æ˜¯å¦å…è®¸æˆ‘ä»¬â€œæšä¸¾å‡ºæ‰€æœ‰å½“å‰çº¿ç¨‹çš„ ThreadLocal å®ä¾‹å¹¶æ¸…ç†â€ã€‚    
> - **å¼ºåˆ¶æ‰§è¡Œæœ€ä½³å®è·µï¼ˆå¦‚æœª remove å°±æŠ›å¼‚å¸¸ï¼‰ï¼š**  é˜²æ­¢å¼€å‘è€…æ»¥ç”¨æˆ–é—å¿˜ï¼Œä¿éšœå¥å£®æ€§ã€‚

è¿™ä¸ªæ€è·¯å…¶å®å·²ç»æ˜¯ **ä¸€äº›æ¡†æ¶ã€å¹³å°ã€çº¿ç¨‹æ± åº“ä¸­æ­£åœ¨æˆ–å°è¯•å®ç°çš„æ–¹å‘**ï¼Œæœ¬è´¨ä¸Šè§¦åŠäº† **ThreadLocal ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†æœºåˆ¶** è¿™ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚

### è‡ªåŠ¨æ¸…é™¤ ThreadLocal â€”â€” å¯è¡Œä½†æœ‰ä»£ä»·


æœ‰ä¸€ä¸ªå­—æ®µ`Thread.threadLocals â†’ ThreadLocalMap`ã€‚å¯ä»¥é€šè¿‡åå°„è®¿é—®è¿™ä¸ª `ThreadLocalMap`ï¼Œå†ä»é‡Œé¢æŠŠæ‰€æœ‰ keyï¼ˆThreadLocal å®ä¾‹ï¼‰å–å‡ºæ¥ï¼Œç„¶åç»Ÿä¸€è°ƒç”¨ `remove()`ã€‚

```java
Field threadLocalsField = Thread.class.getDeclaredField("threadLocals");
threadLocalsField.setAccessible(true);
ThreadLocalMap map = (ThreadLocalMap) threadLocalsField.get(Thread.currentThread());
// éå†å¹¶æ¸…ç†
```

**âŒ ä½†é—®é¢˜åœ¨äºï¼š**

**è¿™æ˜¯å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œå®˜æ–¹ API ä¸æ”¯æŒè®¿é—® ThreadLocalMap**ï¼Œå¼ºè¡Œä½¿ç”¨åå°„ä¿®æ”¹çº¿ç¨‹ç§æœ‰å­—æ®µï¼Œ**ä¸å®‰å…¨ã€æ˜“å´©ã€å¯èƒ½è¢«é™åˆ¶**ï¼›è€Œä¸” ä¸åŒ Java ç‰ˆæœ¬å¯¹å†…éƒ¨ç»“æ„æœ‰å·®å¼‚ï¼Œå…¼å®¹æ€§ä¸å¥½ï¼ŒJVM ä¸ä¿è¯ä½ èƒ½æšä¸¾æ‰€æœ‰ ThreadLocalï¼ˆæ¯”å¦‚ InheritableThreadLocalï¼‰

å› æ­¤ï¼š**ä½ å¯ä»¥â€œé»‘é­”æ³•â€åšåˆ°ï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†çš„åšæ³•ï¼Œå­˜åœ¨é£é™©ã€‚**

### â€œæœªè°ƒç”¨ remove() å°±æŠ›å¼‚å¸¸â€ â€”â€” ç†è®ºä¸Šä¸å¯è¡Œ

Java æ²¡æœ‰æä¾› ThreadLocal çš„ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š

- ä½ æ— æ³•åˆ¤æ–­æŸä¸ª `ThreadLocal` æ˜¯â€œç”¨å®Œäº†ä½†è¿˜æ²¡è¢« removeâ€ï¼Œé™¤éä½ å¼ºè¡ŒåŠ è§„èŒƒï¼ˆå¦‚çº¿ç¨‹ç»“æŸå‰ç»Ÿä¸€æ£€æŸ¥ï¼‰
- Java ä¹Ÿä¸æä¾› hook è®©ä½ ç›‘å¬ `ThreadLocal.get()` æˆ– `ThreadLocal.set()` ä¹‹åæ˜¯å¦ remove

é™¤éä½ æ”¹å†™ ThreadLocalï¼ˆç”¨ä»£ç†æˆ–è‡ªå®šä¹‰ç±»ï¼‰ï¼Œä½†è¿™å°±è„±ç¦»äº†æ ‡å‡†è¯­ä¹‰ã€‚

### æœ€ä¼˜è§£ï¼šæ¡†æ¶
æåˆ°çš„ç›®æ ‡ï¼ŒSpringã€é˜¿é‡Œã€Netty ç­‰éƒ½åœ¨ä»¥ä¸åŒæ–¹å¼å®ç°ï¼š

**Spring**ï¼š

- ä½¿ç”¨ `RequestContextHolder` ç®¡ç† ThreadLocal
- åœ¨è¯·æ±‚ç»“æŸçš„è¿‡æ»¤å™¨ä¸­ç»Ÿä¸€æ¸…ç†ï¼ˆé€šè¿‡æ‹¦æˆªå™¨ã€AOP ç­‰ï¼‰


**é˜¿é‡Œ TransmittableThreadLocalï¼ˆTTLï¼‰ï¼š**

- ä¸º ThreadLocal å¢å¼ºç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼Œè‡ªåŠ¨ä¼ é€’ + è‡ªåŠ¨æ¸…ç†
- å¯ä»¥é…åˆçº¿ç¨‹æ± ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œå‰åè‡ªåŠ¨æ¸…ç†å˜é‡

ğŸ‘‰ GitHubï¼š[https://github.com/alibaba/transmittable-thread-local](https://github.com/alibaba/transmittable-thread-local)

 **è‡ªå®šä¹‰çº¿ç¨‹æ± åŒ…è£…å™¨**ï¼š

ä½ å¯ä»¥æŠŠçº¿ç¨‹æ± æäº¤çš„ä»»åŠ¡åŒ…è£…ä¸€ä¸‹ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œå‰åç»Ÿä¸€æ¸…ç†ï¼š
```java
executor.submit(() -> {
    try {
        task.run();
    } finally {
        clearAllThreadLocals(); // é€šè¿‡ TTL æˆ–åå°„æ–¹å¼æ¸…ç†
    }
});
```
**ç»Ÿä¸€å°è£… Runnable/Callableï¼š**

```java
class SafeRunnable implements Runnable {
    private final Runnable task;

    public SafeRunnable(Runnable task) {
        this.task = task;
    }

    public void run() {
        try {
            task.run();
        } finally {
            clearAllThreadLocals(); // è‡ªå®šä¹‰æ¸…ç†é€»è¾‘
        }
    }
}
```