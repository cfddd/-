很多内容都是代码，看代码理解更快

![](echo_client2.c)
![](op_client.c)
![](op_server.c)


## 链路层
链路层是物理链接领域标准化的结果，也是最基本的领域，专门定义LAN、WAN、MAN等网络标准。 若两台主机通过网络进行数据交换，则需要物理连接，链路层就负责这些标准。
## IP层
IP 是面向消息的、不可靠的协议。每次传输数据时会帮我们选择路径，但并不一致。如果传输过程中发 生错误，则选择其他路径，但是如果发生数据丢失或错误，则无法解决。换言之，IP协议无法应对数据 错误。
## TCP和UDP层
根据数据传输方式的不同，基于网络协议的套接字一般分为TCP套接字和UDP套接字。因为TCP套接字是面向连接的,因此又称基于流( stream)的套接字。
TCP是Transmission Control Protocol(传输控制协议)的简写,意为“对数据传输过程的控制”。因此，学习控制方法及范围有助于正确理解TCP套接字。
## 应用层
利用套接字编出程序，需要根据程序 的特点来决定服务器和客户端之间的数据传输规则。
## TCP服务器端的默认函数调用顺序
![](addition/Pasted%20image%2020230803164414.png)
## TCP客户端的默认函数调用顺序
![](addition/Pasted%20image%2020230803164458.png)
## 基于 TCP 的服务端/客户端函数调用关系
![](addition/Pasted%20image%2020230803164631.png)
# TCP原理
## I/O缓冲
TCP套接字的数据收发无边界。
- I/O缓冲在每个TCP套接字中单独存在。
- I/O缓冲在创建套接字时自动生成。
- 即使关闭套接字也会继续传递输出缓冲中遗留的数据。
- 关闭套接字将丢失输入缓冲中的数据。
重要结论：**不会发生超过输入缓冲大小的数据传输**
## 与对方套接字的连接
TCP套接字从创建到消失所经过程分为如下3步。
- 与对方套接字建立连接。
- 与对方套接字进行数据交换。
- 断开与对方套接字的连接。
### 三次握手建立连接
![](addition/Pasted%20image%2020230803171335.png)
套接字是以全双工(Full-duplex)方式工作的。也就是说，它可以双向传递数据。
首先，请求连接的主机A向主机B传递如下信息:
- [SYN] SEQ : 1000 , ACK: - 
	该消息中的 SEQ 为 1000 ，ACK 为空，而 SEQ 为1000 的含义为 ：**现在传递的数据包的序号为 1000，如果接收无误，请通知我向您传递 1001 号数据包。**
这是首次请求连接时使用的消息，又称为 SYN。SYN 是 Synchronization 的简写，表示收发数据前传输 的同步消息。

接下来主机 B 向 A 传递以下信息：
- [SYN+ACK] SEQ: 2000, ACK: 1001 
   SEQ 为 2000 的含义为： **现传递的数据包号为 2000 ，如果接受无误，请通知我向您传递 2001 号数据包。** 
  而 ACK 1001 的含义为： **刚才传输的 SEQ 为 1000 的数据包接受无误，现在请传递 SEQ 为 1001 的数据包。** 
收发数据前向数据包分配序号，并向对方通报此序号，这都是为了防止数据丢失做的准备。通过项数据 包分配序号并确认，可以在数据包丢失时马上查看并重传丢失的数据包。因此 TCP 可以保证可靠的数据 传输。 

最后观察主机A向主机B传输的消息:
- [ACK] SEQ: 1001，ACK: 2001
  已正确收到传输的SEQ为2000的数据包，现在可以传输SEQ为2001的数据包。

通过这三个过程，这样主机 A 和主机 B 就确认了彼此已经准备就绪。

### 与对方主机的数据交换
按照如下公式传递 ACK 信息：
> ACK 号 = SEQ 号 + 传递的字节数 + 1

ACK 号的增量为传输的数据字节数。
最后 + 1 是为了告知对方下次要传递的 SEQ 号。
![](addition/Pasted%20image%2020230803171151.png)

### 断开与套接字的连接
![](addition/Pasted%20image%2020230803171315.png)