> [什么是CSRF？如何防御CSRF攻击？知了堂告诉你 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/343515825)
> 
> [CSRF漏洞原理攻击与防御（非常细）-CSDN博客](https://blog.csdn.net/qq_43378996/article/details/123910614)

## CSRF的防御方法

### 验证HTTP Referer字段

根据 HTTP 协议，在 HTTP 头中有一个字段叫Referer，它记录了该 HTTP 请求的来源地址。

> 比如我们google搜索出来有网站A，我们点击后跳转到网站A，请求体就中有来源地址：www.google.com

在通常情况下，访问一个安全受限页面的请求来自于同一个网站（比如银行转账）。

对于每一个转账请求验证其 Referer 值，如果是合法网站的域名，则说明该请求是来自有效网站自己的请求，是合法的；

如果 Referer 是其他未知网站的话，则有可能是黑客的 CSRF 攻击，拒绝该请求。

但是使用验证 Referer 值的方法，就是把安全性都依赖于第三方（即浏览器）来保障，从理论上来讲，这样并不安全。
### 为页面增加随机数

网站应该生成一个伪随机值，并将其设为cookie。

用户在第一次登陆后，这个伪随机值就会随着用户id存入session

之后每个body请求体中都应包含该伪随机值，到服务端后进行校验，识别不安全的登录。

同时需要确保这个随机数不容易被窃取或泄露；定期更换随机数，以防止长时间使用相同的随机数。
### 在非GET请求中增加token并验证
要抵御 CSRF关键在于在**请求中放入黑客所不能伪造的信息**，并且该信息不存在于 cookie 之中。

在HTTP请求中加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token。如果请求中没有token或者token内容不正确，则认为可能是CSRF攻击而拒绝该请求。

1. **生成随机token**：
    
    - 在用户登录时，服务器为用户生成一个随机的token，并将其存储在用户的会话中（通常是在cookie中）。
    - 这个token是一个伪随机值，每次用户登录或会话开始时都会重新生成。
    - 服务器还将这个token添加到每个表单中，作为隐藏字段或请求头的一部分。
2. **验证token**：
    
    - 当用户提交一个非GET请求（例如POST请求）时，服务器会检查请求中的token是否与用户会话中存储的token匹配。
    - 如果匹配成功，服务器会处理请求；如果不匹配，服务器会拒绝请求。
    - 这样，即使攻击者能够伪造请求，也无法伪造有效的token，因为他们无法获取用户的会话信息。
3. **保持token的安全性**：
    
    - 确保token不容易被窃取或泄露。使用安全的cookie设置，例如将token标记为`HttpOnly`，以防止JavaScript访问它。
    - 定期更换token，以防止长时间使用相同的token。