> [raft-zh_cn/raft-zh_cn.md at master · maemual/raft-zh_cn (github.com)](https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md#5-raft-%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95)
> [Raft 分布式共识算法动画演示 (kailing.pub)](http://www.kailing.pub/raft/index.html)
> [动画：Raft算法Leader选举、脑裂后选举、日志复制、修复不一致日志和数据安全_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1so4y1r7eM/?spm_id_from=333.337.search-card.all.click)
## 一致性算法是什么？
**一致性，即达成共识**

一致性算法是用于在分布式系统中**确保不同节点之间数据的一致性**的一类算法。

通过协调多个节点的操作，确保在面对网络分区、节点故障等情况下，系统依然能够保持一致的状态。

实际系统中使用的一致性算法通常含有以下特性：

- **安全性保证**（绝对不会返回一个错误的结果）：在非拜占庭错误情况下，包括网络延迟、分区、丢包、重复和乱序等错误都可以保证正确。
- **可用性**：集群中只要有大多数的机器可运行并且能够相互通信、和客户端通信，就可以保证可用。因此，一个典型的包含 5 个节点的集群可以容忍两个节点的失败。
- **不依赖时序来保证一致性**：物理时钟错误或者极端的消息延迟只有在最坏情况下才会导致可用性问题。 
- **迅速响应客户端请求**：一致性算法通常会尽可能快地响应客户端的请求，即使一小部分节点的响应速度较慢，也不会影响系统整体的性能。这意味着系统的性能不会受到个别节点的影响，而是整个集群的响应速度。

> 非拜占庭错误：因为不可预测的行为，导致系统无法正常运行，类似有内鬼节点。
> 
> **管理复制日志**：保持一致性的方案名称
## Raft 一致性算法
Raft 通过选举一个杰出的领导人，然后给予他全部的管理复制日志的责任来实现一致性。

领导人从客户端接收日志条目，把日志条目复制到其他服务器上，并告诉其他的服务器什么时候可以安全地将日志条目应用。

过领导人的方式，Raft 将一致性问题分解成了三个相对独立的子问题
1. **领导选举**
2. **日志复制**
3. **安全性**
### Raft 基础

![](https://github.com/maemual/raft-zh_cn/raw/master/images/raft-%E5%9B%BE4.png)

在任何时刻，每一个服务器节点都处于这三个状态之一：**领导人、跟随者或者候选人**。
- **领导人**：
	系统中只有一个，并且其他的节点全部都是跟随者。
	
	领导人处理所有的客户端请求（如果一个客户端和跟随者联系，那么跟随者会把请求重定向给领导人）
- **候选人**：
	选举新领导人时使用
- **跟随者**：
	被动的，简单的响应来自领导人或者候选人的请求。

### 领导人选举
当服务器程序启动时，所有人都是**跟随者**。

跟随者响应来自其他服务器的请求。如果跟随者（**限定时间内**）接收不到消息，那么他就会变成候选人并发起一次选举。Raft 使用一种心跳机制来触发领导人选举。

选举时，候选人首先增加自己的任期号，并调用RPC让其他跟随者投票。

获得集群中大多数选票的候选人将成为领导人，他会立即通知其他人，并让他们回到跟随者的状态，阻止发生选举。在一个任期内，领导人一直都会是领导人，直到自己宕机了。

> 如果有多个候选人让跟随者投票怎么办？

每一个跟随者最多会对一个任期号投出一张选票，按照先来先服务的原则。

> 候选人如果在候选时接受到了其他人的领导命令，怎么处理？

根据发送来的任期号，如果小于等于自己就拒绝；反之，则承认。

> **如果选举后没有选举出领导人该怎么办？**
![](https://github.com/maemual/raft-zh_cn/raw/master/images/raft-%E5%9B%BE5.png)

Raft 把时间分割成任意长度的**任期**

如果一个候选人赢得选举，然后他就在接下来的任期内充当领导人的职责。

在某些情况下，一次选举过程选票被多个节点瓜分，导致没有节点超过半数票而选举出领导，这一任期会以没有领导人结束；

当这种情况发生的时候，**每一个候选人都会超时**，然后通过增加当前任期号来开始一轮新的选举。

> **接下来选举后还是没有选举出领导人该怎么办？**

当没有选举出领导人的问题发生的时候，每一个候选人都会超时，然后通过增加当前任期号来开始一轮新的选举。

如果没有一个良好的机制，确实会存在一直选举的可能性

于是 Raft 算法使用**随机超时时间**的方法来确保很少会发生选票瓜分的情况，就算发生也能很快的解决。这样减少了在新的选举中另外的选票瓜分的可能性。

> 为什么用随机设置超时时间？

经过大量的实验得出的结果，随机超时是最优的。比按照某些优先级进行重新选举更可靠（优先级高的挂了，会导致再次选举）
### 日志复制
**领导人被选举出来后，他就开始为客户端提供服务。**

客户端的每一个请求或指令都被附加到日志中去，