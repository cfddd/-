
<https://zhuanlan.zhihu.com/p/391327282>
## 虚拟存储器
虚拟内存地址是基于物理内存地址之上凭空而造的一个新的逻辑地址，而操作系统暴露给用户进程的只是虚拟内存地址，操作系统内部会对虚拟内存地址和真实的物理内存地址做映射关系，来管理地址的分配，从而使物理内存的利用率提高。

这样**用户程序（进程）只能使用虚拟的内存地址来获取数据，系统会将这个虚拟地址翻译成实际的物理地址**。这里面每一个程序统一使用一套连续虚拟地址，比如 0x 0000 0000 ~ 0x ffff ffff。

**从程序的角度来看，它觉得自己独享了一整块内存，且不用考虑访问冲突的问题。系统会将虚拟地址翻译成物理地址，避免进程与进程之间冲突的同时，从内存上加载数据。**
## 主要组成部分
### 1.虚拟空间地址
程序员所看到的地址空间，是一个连续的、逻辑上的地址范围。
### 2.物理内存
即计算机系统实际安装的内存，是实实在在的存储硬件，用于存放当前正在运行的程序和数据。物理内存也被划分为与虚拟页面大小相同的页框，用于存储从虚拟地址空间调入的页面。
### 3.页表
页表是实现虚拟地址到物理地址映射的关键数据结构。它记录了虚拟地址空间中的每个页面与物理内存中的页框之间的对应关系。

当 CPU 访问一个虚拟地址时，首先会通过页表查找该虚拟地址对应的物理地址，然后再根据物理地址访问物理内存。
## 工作过程
### 页面调入
当程序访问一个不在物理内存中的虚拟页面时，会引发一个页面故障（Page Fault）中断。

操作系统的页面调度程序会响应这个中断，根据一定的页面置换算法，选择一个物理内存中的页面，如果该页面已被修改，则将其写回外存，然后从外存中读取需要的页面到物理内存的空闲页框中，并更新页表，建立新的虚拟地址到物理地址的映射关系，最后重新执行引发页面故障的指令。
### 页面置换
由于物理内存的大小是有限的，当物理内存中没有空闲页框可供使用时，就需要选择一个已在物理内存中的页面将其置换出去，以便为新调入的页面腾出空间。

常见的页面置换算法有先进先出算法（FIFO）、最近最少使用算法（LRU）、时钟算法等。不同的算法在不同的应用场景下具有不同的性能表现，其目标是尽量减少页面置换的次数，提高系统的整体性能。

## 优缺点
**优点**：
- **扩大地址空间**：虚拟存储器使得每个程序都可以拥有一个比实际物理内存大得多的虚拟地址空间，从而可以编写和运行更大规模的程序，不必担心物理内存的限制。
- **提高内存利用率**：通过将暂时不使用的页面置换到外存，虚拟存储器可以使物理内存中始终存放的是当前最需要访问的页面，提高了物理内存的利用率。
- **方便了内存的管理**：操作系统可以根据程序的需求动态地分配和回收物理内存页面，而不必关心程序具体的内存使用情况。同时，通过页表可以方便地实现对内存的保护，防止不同程序之间的非法访问，提高了系统的安全性和稳定性。

**缺陷**：
- **性能开销**：虚拟存储器的实现需要一定的硬件和软件支持，如 MMU（内存管理单元）等，这会增加系统的复杂性和成本
- **页面碎片**：随着程序的运行和页面的不断调入调出，物理内存中可能会出现页面碎片，即空闲的页框不连续，分散在各个地方。
## 页面置换算法

当需要调入新页面，但内存已满时，页面置换算法 选择一个被换出的页面，再将新页面载入

#### 先进先出算法

#### OPT页面置换算法

最佳算法（OPTimal）：选择未来最久不被访问的

不可能实现！（预测未来最热卖的商品）

意义：给出理论上的最好结果，以供比较

#### 最近最久未使用（Least Recently Used）LRU

选择自上次被访问以来经历时间最久的

硬件开销太大，难以实现

实际OS中，采用近似LRU的方法

#### Clock算法

循环队列，依次检查。若A（访问位）=0，换出；若A=1，置A=0，检查下一个。

改进后

不仅利用访问位A，还利用修改位D

- A=0，D=0，最近未访问，也未被修改；
- A=0，D=1，最近未访问，但被修改；
- A=1，D=0，最近被访问，但未被修改；
- A=1，D=1，最近被访问，且被修改。

AD=00最应该被替换，AD=11最不应替换

## 页面分配策略

给每个进程分配至少多少个物理块

#### 固定分配和可变分配
给每个进程分配多少个物理块？

**固定**

- 平均分配算法
- 比例分配算法
- 优先级分配算法
  
**可变**

允许分配给进程的物理块数随时间变化

#### 全局&局部置换

可变分配在置换时，换出属于谁的页面？

若每个进程已经**固定分配**物理页面数量，则不可能去抢夺其它进程的页面，因而也就不可能**全局置换**。

**全局置换（Global Replacement）**

- 可以置换所有进程的页面

**局部置换（Local Replacement）**

- 仅置换进程自己的页面

## 页面缓冲算法

页缓冲算法（PBA，Page Buffering Algorithm）

- 空闲页面池，统一管理空闲的物理页面
- 修改页面池，将D=1的页面暂存

好处：防止将被换出的页面马上又要使用的情况（house keeping）

## 实用策略-工作集

- 进程开始执行后，随着访问新页面逐步建立较稳定的工作集
- 当内存访问的局部性区域的位置大致稳定时，工作集大小也大致稳定
- 局部性区域的位置改变时，工作集快速扩张和收缩过渡到下一个稳定值

## 抖动

- CPU利用率与并发进程数存在相互促进和制约的关系
  - 进程数少时，提高并发进程数，可提高CPU利用率
  - 并发进程进一步增加，导致内存访问增加
  - 分配给每个进程的物理块太少，导致缺页率上升和CPU利用下降
  - 抖动：每个进程频繁的缺页，换进/换出
- 抖动
  - 进程物理页面太少，不能包含工作集
  - 造成大量缺页，频繁置换
  - 进程运行速度变慢
- 产生抖动的原因
  - 随着驻留内存的进程数目增加，分配给每个进程的物理页面数
  - 不断减小，缺页率不断上升
- 抖动的预防方法
  - 采用局部置换策略
  - 把工作集算法融入处理机调度
  - “L=S”准则
  - 选择暂停的进
